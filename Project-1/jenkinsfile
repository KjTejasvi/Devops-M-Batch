pipeline {
    parameters {
        choice(name :'Terraformaction', choices: ['apply','destroy'],description: 'choose the terraform action')
    }
	
	environment {
		AWS_ACCESS_KEY_ID = credentials("Access-Key")
		AWS_SECRET_KEY_ID = credentials("Secret-Key")
	}
	
	agent any 
		stages {
			stage('Git-Checkout'){
				steps {
					script{
						dir("iac-repo"){
						git branch: 'IAC-Project', url:'https://github.com/KjTejasvi/Devops-M-Batch.git'
                        }
                    }
				}
			}
			
			stage('Plan') {
				steps {
					sh '''
                cd iac-repo/Project-1
                terraform init
                terraform plan -out tfplan
                terraform show -no-color tfplan > ../tfplan.txt
                '''
				}
			}
			
			stage('Approval') {
				steps {
					script {
						def plan = readFile 'iac-repo/tfplan.txt'
						input (
						message = 'Do you want to proceed with the terraform action..?' 
						parameters:[ text(name: 'paln' , description: 'Can you reweive the plan', defaultValue: 'plan')]
						)
					}
				}
			}
			
        
			stage('apply or destroy') {
				when {
					expression{  return params.Terraformaction =='apply' || params.Terraformaction == 'destroy'
					}
				}
				
				steps {
                    script {
					if (params.Terraformaction == 'apply'){
						sh ' cd IAC-Repo/Project-1 terraform apply -input = false tfplan'
					}else if (params.Terraformaction == 'destroy') {
						sh ' cd IAC-Repo/Project-1 terraform destroy -auto-approve'
					}
                    }
				}
			}				
        }
}